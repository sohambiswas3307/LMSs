<!DOCTYPE html>
<html>
<head>
  <title><%= course.title %> - Assignments</title>
</head>
<body>
  <h1><%= course.title %> - Assignments</h1>

  <!-- Teacher: Create new assignment -->
  <% if (role === 'Teacher') { %>
    <h2>Create New Assignment</h2>
    <form action="/course/<%= course.id %>/assignments/create" method="POST" enctype="multipart/form-data">
      <label>Title:</label>
      <input type="text" name="title" required><br><br>

      <label>Description:</label>
      <textarea name="description" required></textarea><br><br>

      <label>Due Date:</label>
      <input type="date" name="due_date" required><br><br>

      <label>Points (0-100):</label>
      <input type="number" name="points" min="0" max="100" required><br><br>

      <label>Upload File (PDF/DOC/DOCX):</label>
      <input type="file" name="file" accept=".pdf,.doc,.docx"><br><br>

      <button type="submit">Create Assignment</button>
    </form>
  <% } %>

  <h2>All Assignments</h2>
  <% if (assignments.length === 0) { %>
    <p>No assignments yet.</p>
  <% } else { %>
    <ul>
      <% assignments.forEach(a => { %>
        <li>
          <strong><%= a.title %></strong> - Due: <%= a.due_date ? a.due_date.toISOString().slice(0,10) : 'N/A' %><br>
          <%= a.description %><br>

          <!-- Show teacher-set points -->
          <p>Points: <%= a.points %></p>

          <!-- Assignment file download -->
          <% if (a.file_path) { %>
            <a href="/uploads/<%= a.file_path %>" target="_blank">Download Assignment</a><br>
          <% } %>

          <!-- Teacher: View all submissions -->
          <% if (role === 'Teacher') { %>
            <a href="/course/<%= course.id %>/assignments/<%= a.id %>/submissions">View Submissions</a>
          <% } %>

          <!-- Student: Submit assignment -->
          <% if (role === 'Student') { %>
            <% 
              const submitted = a.submissions?.find(s => s.student_id === user.id);
              if(!submitted){ %>
                <form action="/assignments/<%= a.id %>/submit" method="POST" enctype="multipart/form-data">
                  <input type="hidden" name="courseId" value="<%= course.id %>">
                  <input type="file" name="file" required>
                  <button type="submit">Submit Assignment</button>
                </form>
            <% } else { %>
                <p>You submitted: <a href="/uploads/<%= submitted.file_path %>" target="_blank">Download</a></p>
                <% if(submitted.grade != null){ %>
                  <p><strong>Grade:</strong> <%= submitted.grade %> / <%= a.points %></p>
                  <% if(submitted.feedback){ %>
                    <p><strong>Feedback:</strong> <%= submitted.feedback %></p>
                  <% } %>
                <% } else { %>
                  <p>Your submission has not been graded yet.</p>
                <% } %>
            <% } %>
          <% } %>

        </li>
        <br>
      <% }) %>
    </ul>
  <% } %>

  <br>
  <a href="/home">Back to Home</a>
</body>
</html>
